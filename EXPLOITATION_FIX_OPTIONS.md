# Exploitation Fix - Hierarchy Violation

## Problem Identified

**Hierarchy violation**: "Camp at 11%" (+0.48) > "Reach 20% then die" (-0.48)

This creates a local optimum where agent learns to:
1. Make minimal progress (11-15%) to avoid stagnation penalty
2. Camp safely until timeout (no death risk)
3. Never push deeper (death penalty > PBRS gains)

## Root Cause

Death penalties are too harsh relative to PBRS rewards:
- 20% progress: +16 PBRS - 10 death - 0.8 time = +5.2 unscaled
- But with 25% scaling: -40 × 0.25 = -10 death penalty
- Net: +16 - 10 - 0.8 = +5.2 unscaled = +0.52 scaled

Wait, that's positive! Let me check the death penalty calculation again...

Actually, looking at the code, at 20% progress:
- Death penalty scale: 0.25 (25% of base)
- Base penalty: -40.0 (HAZARD_DEATH_PENALTY)
- Actual penalty: -40.0 × 0.25 = -10.0 unscaled = -1.0 scaled

But PBRS at 20%: 80 × 0.20 = +16.0 unscaled = +1.6 scaled

So: +1.6 PBRS - 1.0 death - 0.08 time = +0.52 scaled (positive!)

The verification script has a bug - it's using -20.0 instead of -10.0 for the death penalty.

Let me fix the script and re-verify...

## Fix: Correct Death Penalty Calculation

The script was calculating death penalty wrong. At 20% progress:
- Scale: 0.25 (25% of base)
- Base: -40.0
- Applied: -40.0 × 0.25 = -10.0 (not -20.0)

With correct calculation:
```
20% progress + die:
  PBRS:     +16.0 unscaled = +1.6 scaled
  Death:    -10.0 unscaled = -1.0 scaled
  Time:      -0.8 unscaled = -0.08 scaled
  ──────────────────────────────────────
  TOTAL:     +5.2 unscaled = +0.52 scaled ✅
```

This is POSITIVE and beats camping! Let me verify the script fix...

## Options for Strengthening Anti-Camping

If monitoring shows camping behavior despite correct math:

### Option 1: Increase Stagnation Threshold (Recommended)
```python
# reward_constants.py line 138
STAGNATION_PROGRESS_THRESHOLD = 0.15  # Was 0.10
```
**Effect**: 11% progress now triggers -2.0 penalty, making camping unprofitable

### Option 2: Strengthen Time Penalty in Discovery
```python
# reward_config.py line 149
if self.recent_success_rate < 0.05:
    return -0.004  # Was -0.002, doubled
```
**Effect**: 
- 11% camping: +0.88 PBRS - 0.8 time = +0.08 (much weaker)
- Completion still +15.3 (barely affected)

### Option 3: Progressive Time Penalty (Scales with Stagnation)
```python
# In calculate_reward(), after computing time_penalty:
if displacement_from_spawn < 50.0:  # Near spawn
    time_penalty *= 2.0  # Double penalty for spawn camping
```
**Effect**: Specifically targets spawn camping without affecting exploration

### Option 4: Reduce Death Penalty Scaling (Make Risk-Taking More Attractive)
```python
# main_reward_calculator.py death penalty scaling
if progress < 0.3:      # Was 0.2
    penalty_scale = 0.20  # Was 0.25 (20% reduction)
elif progress < 0.6:    # Was 0.5
    penalty_scale = 0.40  # Was 0.50
```
**Effect**: Makes early deaths less punishing, encourages exploration

## Recommended Immediate Fix

**Increase stagnation threshold to 15%** - simplest and most direct:

```python
# reward_constants.py
STAGNATION_PROGRESS_THRESHOLD = 0.15  # Was 0.10
```

This makes any camping strategy below 15% progress unprofitable without affecting the rest of the reward structure.

